<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KYC Home</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
    body {
        padding: 20px;
    }

    /* Menu Bar */
    .menu-bar {
        display: flex;
        justify-content: flex-end;
        margin-bottom: 20px;
        gap: 10px;
    }

    .container-flex {
        display: flex;
        flex-wrap: wrap;
        gap: 20px;
    }

    .aadhaar-section,
    .pan-section {
        width: 50%;
        box-sizing: border-box;
    }

    .section {
        border: 1px solid #ccc;
        border-radius: 8px;
        padding: 20px;
        margin: 0;
        flex: 1;
        display: flex;
        flex-direction: column;
    }

    .json-output {
        margin-top: 15px;
        background: #f8f9fa;
        padding: 10px;
        border-radius: 5px;
        max-height: 300px;
        overflow-y: auto;
        white-space: pre-wrap;
        font-family: monospace;
        width: 100%;
    }

    /* Result Section */
    .result-section {
        border: 1px solid #007bff;
        border-radius: 8px;
        padding: 20px;
        margin-top: 30px;
        background: #e9f7ff;
    }

    @media screen and (max-width: 768px) {
        .aadhaar-section,
        .pan-section {
            width: 100%;
        }
    }
</style>
</head>

<body>
    <!-- Menu Bar -->
    <div class="menu-bar">
        <button class="btn btn-info" onclick="fetchResult()">Result</button>
        <button class="btn btn-danger" onclick="logout()">Logout</button>
    </div>

    <h2>KYC Verification Home</h2>
    <div class="container-flex">
        <!-- Aadhaar Section -->
        <div class="section aadhaar-section">
            <h4>Aadhaar Card</h4>
            <input type="file" id="aadhaarFile" class="form-control mb-2">
            <button class="btn btn-primary mb-2" onclick="uploadAadhaar()">Upload</button>
            <div id="aadhaarUploadOutput" class="json-output"></div>

            <button class="btn btn-success mt-3" onclick="saveAadhaar()">Save</button>
            <div id="aadhaarSaveOutput" class="json-output"></div>
        </div>

        <!-- PAN Section -->
        <div class="section pan-section">
            <h4>PAN Card</h4>
            <input type="file" id="panFile" class="form-control mb-2">
            <button class="btn btn-primary mb-2" onclick="uploadPAN()">Upload</button>
            <div id="panUploadOutput" class="json-output"></div>

            <button class="btn btn-success mt-3" onclick="savePAN()">Save</button>
            <div id="panSaveOutput" class="json-output"></div>
        </div>
    </div>

    <!-- Spinner (hidden by default) -->
    <div id="loadingSpinner" class="text-center my-3" style="display:none;">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <p>Fetching your KYC result...</p>
    </div>

    <!-- Result Section -->
    <!-- Result output -->
    <div id="resultOutput" class="card p-3 shadow-sm"></div>

<script>
    let aadhaarData = null;
    let panData = null;
    let jwtToken = null; // save JWT after saving Aadhaar

    // ---------- Aadhaar Functions ----------
    /*async function uploadAadhaar() {
        const fileInput = document.getElementById('aadhaarFile');
        if (fileInput.files.length === 0) return alert("Please select a file");

        const formData = new FormData();
        formData.append('file', fileInput.files[0]);

        try {
            const response = await fetch('/api/extract', { method: 'POST', body: formData });
            const data = await response.json();
            aadhaarData = data;
            document.getElementById('aadhaarUploadOutput').innerText = JSON.stringify(data, null, 2);
        } catch (err) {
            console.error(err);
            alert("Error uploading Aadhaar file");
        }
    }*/
    async function uploadAadhaar() {
        const fileInput = document.getElementById('aadhaarFile');
        if (fileInput.files.length === 0) return alert("Please select a file");

        const formData = new FormData();
        formData.append('file', fileInput.files[0]);

        try {
            const token = localStorage.getItem("token");
            const response = await fetch('/api/extract', { method: 'POST',
            headers: { "Authorization": `Bearer ${token}`},
            body: formData });

            const data = await response.json();

            if (!response.ok) {
                alert(data.error || "Error uploading Aadhaar file");
                return;
            }

            aadhaarData = data;
            document.getElementById('aadhaarUploadOutput').innerText = JSON.stringify(data, null, 2);
        } catch (err) {
            console.error(err);
            alert("Error uploading Aadhaar file");
        }
    }


    /*async function saveAadhaar() {
        if (!aadhaarData) return alert("Please upload Aadhaar first");

        try {
            const response = await fetch('/save_aadhaar', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(aadhaarData)
            });
            const data = await response.json();
            jwtToken = data.token; // store JWT for PAN saving
            document.getElementById('aadhaarSaveOutput').innerText = JSON.stringify(data, null, 2);
        } catch (err) {
            console.error(err);
            alert("Error saving Aadhaar data");
        }
    }*/

    async function saveAadhaar() {
        if (!aadhaarData) return alert("Please upload Aadhaar first");
        const jwtToken = localStorage.getItem("token");
        if (!jwtToken) return alert("JWT token missing!");  // check

        try {
            const response = await fetch('/save_aadhaar', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${jwtToken}`},   // <-- add token here
                body: JSON.stringify(aadhaarData)
            });
            const data = await response.json();
            document.getElementById('aadhaarSaveOutput').innerText = JSON.stringify(data, null, 2);
        } catch (err) {
            console.error(err);
            alert("Error saving Aadhaar data");
        }
    }


    // ---------- PAN Functions ----------
   /* async function uploadPAN() {
        const fileInput = document.getElementById('panFile');
        if (fileInput.files.length === 0) return alert("Please select a file");

        const formData = new FormData();
        formData.append('file', fileInput.files[0]);

        try {
            const response = await fetch('/api/extract_pan', { method: 'POST', body: formData });
            const data = await response.json();
            panData = data;
            document.getElementById('panUploadOutput').innerText = JSON.stringify(data, null, 2);
        } catch (err) {
            console.error(err);
            alert("Error uploading PAN file");
        }
    } */

    // ---------- PAN Functions ----------
    async function uploadPAN() {
        const fileInput = document.getElementById('panFile');
        if (fileInput.files.length === 0) return alert("Please select a file");

        const formData = new FormData();
        formData.append('file', fileInput.files[0]);

        try {
            const token = localStorage.getItem("token"); // JWT from login
            const response = await fetch('/api/extract_pan', {method: 'POST',headers: { "Authorization": `Bearer ${token}` },
                body: formData});

            const data = await response.json();

            if (!response.ok) {
                alert(data.error || "Error uploading PAN file");
                return;
            }

            panData = data;
            document.getElementById('panUploadOutput').innerText = JSON.stringify(data, null, 2);
        } catch (err) {
            console.error(err);
            alert("Error uploading PAN file");
        }
    }


    async function savePAN() {
        if (!panData) return alert("Please upload PAN first");
        const jwtToken = localStorage.getItem("token");
        if (!jwtToken) return alert("Please save Aadhaar first");

        try {
            const response = await fetch('/save_pan', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${jwtToken}`
                },
                body: JSON.stringify(panData)
            });
            const data = await response.json();
            document.getElementById('panSaveOutput').innerText = JSON.stringify(data, null, 2);
        } catch (err) {
            console.error(err);
            alert("Error saving PAN data");
        }
    }

    // ---------- Fetch KYC Result ----------
    async function fetchResult() {
    const jwtToken = localStorage.getItem("token");
    if (!jwtToken) return alert("Please save Aadhaar first to fetch result");

    const spinner = document.getElementById('loadingSpinner');
    const output = document.getElementById('resultOutput');

    // Show spinner, clear previous result
    spinner.style.display = 'block';
    output.innerHTML = '';

    try {
        const response = await fetch('/api/user/result', {
            method: 'GET',
            headers: { 'Authorization': `Bearer ${jwtToken}` }
        });

        const res = await response.json();

        // Artificial delay for UX (2 sec)
        setTimeout(() => {
            spinner.style.display = 'none';

            if (res.data) {
                const d = res.data;
                output.innerHTML = `
                    <h5>KYC Result</h5>
                    <table class="table table-bordered">
                        <tr><th>Name</th><td>${d.Name}</td></tr>
                        <tr><th>DOB</th><td>${d.DOB}</td></tr>
                        <tr><th>Gender</th><td>${d.Gender}</td></tr>
                        <tr><th>Status</th><td><span class="badge bg-info">${d.Status}</span></td></tr>
                    </table>
                `;
            } else {
                output.innerHTML = `<div class="alert alert-warning">${res.message}</div>`;
            }
        }, 2000); // 2 sec delay

    } catch (err) {
        spinner.style.display = 'none';
        console.error(err);
        alert("Error fetching KYC result");
    }
}


    // ---------- Logout ----------
    async function logout() {
        try {
            await fetch('/api/logout', { method: 'POST' });
        } catch (err) {
            console.error(err);
        }
        // Remove token and redirect
        jwtToken = null;
        window.location.href = "/"; // redirect to main.html
    }
</script>
</body>
</html>
